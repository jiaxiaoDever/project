/*!
* yhui 1.3.0beta
* jquery.yhTabs.js
* 2013-04-23
*/
(function(t){t.widget("yhui.yhTabs",t.ui.tabs,{version:"1.3.0beta",options:{frame:!1,showLoading:!1,standTimeout:0,timeOut:1e4,tooltip:!0,add:null},_consts:{LISTACTIVED:"yhui-tabs-list-actived",TABID:"data-yhui-tabid",TAB:"<li title='{title}'><a href='#{href}'>{title}</a></li>",CTAB:"<li title='{title}'><a href='#{href}'>{title}</a><span title = '关闭' class='ui-icon ui-icon-close yhui-tabs-close'>Remove Tab</span></li>"},_create:function(){if(this._super(),this.element.addClass("yhui-tabs"),this.options.frame){if(!this.element.find("div.yhui-tabs-header-inner").length)return t.yhui.log("bad structure!");this._parse()}this._events()},addTab:function(e,i,s){if(!this.options.frame)return t.yhui.log("use add ?");var a,n;a=e[0].getAttribute(this._consts.TABID),a||(a="yhtabs-"+t.now(),e[0].setAttribute(this._consts.TABID,a)),t("#"+a).length?this._itemClick(a):(s=s||t.trim(e.text())||"选项卡",n={title:s,id:a,src:i,close:!0,capture:!0},this.options.showLoading&&this._timeOutStart(),this.add(n),this._addTabCheck(),this._addItemToRightList(s,a))},_removeTab:function(e,i){var s=e.remove().attr("aria-controls"),a=t("#"+s),n=a.find("iframe");n.length&&n.attr("src","about:blank").remove(),a.remove(),i||(this.refresh(),this._removeTabCheck()),this.options.frame&&(this._removeItemFromRightList(s),this.options.showLoading&&this.loading.off("dialogbeforeclose")),t.yhui.isIE&&CollectGarbage()},_parse:function(){this.header=this.element.find("div").first().addClass("ui-widget-header").append('<div class = "yhui-tabs-arrow-w ui-icon ui-icon-triangle-1-w" role = "data-yhui-tabs-btn"></div><div class = "yhui-tabs-arrow-e ui-icon ui-icon-triangle-1-e" role = "data-yhui-tabs-btn"></div><div class = "yhui-tabs-arrow-s ui-icon ui-icon-circle-triangle-s" role = "data-yhui-tabs-btn"></div><div class = "yhui-tabs-refresh ui-icon ui-icon-refresh" role = "data-yhui-tabs-btn"></div>'),this.container=this.element.find("div.ui-layout-content").eq(0).addClass("yhui-tabs-panels"),this.headerInner=this.header.find("div.yhui-tabs-header-inner").eq(0),this.wArrow=this.header.find("div.yhui-tabs-arrow-w").eq(0),this.sArrow=this.header.find("div.yhui-tabs-arrow-s").eq(0),this.animated=!1,this._parseRightList(),this.options.showLoading&&this._parseTimeOut(),this.tabs[0].title=t.trim(this.tabs.eq(0).text()),this.usualValue=this.tabs.eq(0).outerWidth()+parseInt(this.tabs.eq(0).css("marginRight"),10)+parseInt(this.tabs.eq(0).css("marginLeft"),10),this.options.tooltip&&this.tablist.tooltip({items:"li[title]",position:{at:"left top-52"}})},_parseRightList:function(){var e=this.tabs[0].getAttribute("aria-controls");this.rightListUp=t('<ul class = "yhui-tabs-list-up" ><li role = "data-yhui-tabs-rightlist" data-yhui-tabid = "'+e+'" class = "yhui-tabs-list-actived">'+t.trim(this.tabs.first().text())+"</li></ul>"),this.rightListDown=t('<ul class = "yhui-tabs-list-menu"><li role = "data-yhui-tabs-rightcontrol">关闭当前选项卡</li><li role = "data-yhui-tabs-rightcontrol">关闭其他选项卡</li><li role = "data-yhui-tabs-rightcontrol">关闭全部选项卡</li></ul>'),this.rightList=t('<div class = "yhui-tabs-list"></div>').append(this.rightListUp,this.rightListDown).appendTo(this.element.find("div.yhui-tabs-header"))},_parseTimeOut:function(){this.loading=t('<div class = "yhui-tabs-loading" title = "加载中……"></div>').appendTo(this.document[0].body).dialog({modal:!0,autoOpen:!1,draggable:!1,resizable:!1,buttons:{"取消加载":function(){t(this).dialog("close")}},create:function(){t(this).dialog("widget").find("a.ui-dialog-titlebar-close").hide()},height:180,position:["center","top+15%"],open:function(){t.yhui.isIE67&&t(this).dialog("widget").find("button").blur()}})},_events:function(){var e=this,i=this._parseEventType("click"),s=this._parseEventType("mouseenter mouseleave click");if(this.document.on(e._parseEventType("click"),function(i){t(i.target).closest("div.yhui-tabs-list").length||-1!==i.target.className.indexOf("yhui-tabs-arrow-s")||e._rightListHide()}),e._contextMenu(),e.element.on(i,".yhui-tabs-close",function(){e._removeTab(t(this.parentNode))}).on(e._parseEventType("mouseleave"),".yhui-tabs-list",function(){e._rightListHide()}).on(s,"[role=data-yhui-tabs-btn]",function(i){if("mouseenter"===i.type&&t(this).addClass("yhui-tabs-arrow-hover"),"mouseleave"===i.type&&t(this).removeClass("yhui-tabs-arrow-hover"),"click"===i.type){var s=this.className;-1!==s.indexOf("refresh")&&e.refreshActive(),(-1!==s.indexOf("arrow-w")||-1!==s.indexOf("arrow-e"))&&e._fixedPosition(s),-1!==s.indexOf("arrow-s")&&(e.rightList.is(":hidden")?e._rightListShow():e._rightListHide())}}).on(s,"[role=data-yhui-tabs-rightlist],[role=data-yhui-tabs-rightcontrol]",function(i){var s=this.getAttribute("role");switch(i.type){case"mouseleave":t(this).removeClass("yhui-tabs-list-hover");break;case"mouseenter":!t(this).hasClass("yhui-tabs-list-disable")&&t(this).addClass("yhui-tabs-list-hover");break;case"click":"data-yhui-tabs-rightlist"===s?e._itemClick(this.getAttribute(e._consts.TABID),this):e._rightContol(this)}}),e.options.frame){var a=this.container.find("div").first().find("iframe");a.length&&a.on(e._parseEventType("load"),function(){try{t(a[0].contentWindow.document).on("click",function(){e._rightListHide()})}catch(i){}})}},_parseEventType:function(e){var i,s=this.eventNamespace;if(-1===e.indexOf(" "))i=e+s;else{var a=[];t.each(e.split(" "),function(t,e){a.push(e+s)}),i=a.join(" ")}return i},_fixedPosition:function(e){var i=this,s=i.tablist.eq(0),a=s.position().left,n=2*i.usualValue;-1!==e.indexOf("arrow-w")&&(0>a?s.animate({left:"+="+n+"px"},function(){t(this).position().left>0&&t(this).animate({left:"0px"})}):s.animate({left:"+="+n+"px"}).animate({left:"0px"})),-1!==e.indexOf("arrow-e")&&(a=Math.abs(a),i.maxValue>a?s.animate({left:"-="+n+"px"},function(){Math.abs(t(this).position().left)>i.maxValue&&t(this).animate({left:-i.maxValue+"px"})}):s.animate({left:"-="+n+"px"}).animate({left:"+="+n+"px"}))},_fixedLeftDistance:function(){var t=this.tablist.eq(0),e=Math.abs(t.position().left),i=this.active.eq(0).position().left,s=e-i,a=i-(e+this.headerInner.width()),n=a+this.usualValue;s>=0&&t.animate({left:"+="+s+"px"}),a>=0&&t.animate({left:"-="+n+"px"})},_addTabCheck:function(){var t=this.tablist.eq(0);this.maxValue=this.tabs.length*this.usualValue-this.headerInner.width(),this.maxValue>0&&(this._arrowFadeIn(),this.animated||(this.maxValue+=this.updateOffset,this.animated=!0),t.animate({left:"-"+this.maxValue+"px"}))},_removeTabCheck:function(e){var i=this,s=i.tablist.eq(0);if(e){var a=this.tabs.length*this.usualValue-this.headerInner.width();return 0>=a&&(this._arrowFadeOut(),s.css("left","0px")),void 0}this.maxValue-=this.usualValue,0>s.position().left&&s.animate({left:"+="+this.usualValue+"px"},function(){t(this).position().left>=0&&(t(this).animate({left:"0px"}),i.animated=!1,i._arrowFadeOut())})},_itemClick:function(e,i){this.option("active",this._getIndex(e)),this._fixedLeftDistance(),i&&t(i).addClass(this._consts.LISTACTIVED).siblings().removeClass(this._consts.LISTACTIVED)},_rightContol:function(t){if("yhui-tabs-list-disable"!==t.className){switch(t.innerHTML){case"关闭当前选项卡":var e=this.active.find("span.yhui-tabs-close");e.length&&e.trigger("click");break;case"关闭其他选项卡":this._closeOthers(this.active);break;case"关闭全部选项卡":this._closeAll()}this._rightListHide()}},_arrowFadeIn:function(){this._arrowVisible()||this.headerInner.css("margin","0 54px 0 18px").siblings(".yhui-tabs-arrow-w,.yhui-tabs-arrow-e").show(),this.updateOffset=2*parseInt(this.headerInner.css("marginLeft"),10)},_arrowFadeOut:function(){this.headerInner.css("margin","0 36px 0 0").siblings(".yhui-tabs-arrow-w,.yhui-tabs-arrow-e").hide()},_arrowVisible:function(){return this.wArrow.is(":visible")},_rightListShow:function(){var e=this;1===this.tabs.length?this.rightListDown.find("li").addClass("yhui-tabs-list-disable"):2===this.tabs.length?this.rightListDown.find("li").removeClass("yhui-tabs-list-disable").eq(1).addClass("yhui-tabs-list-disable"):this.rightListDown.find("li").removeClass("yhui-tabs-list-disable"),this.sArrow.addClass("ui-icon-circle-triangle-n"),this.rightList.slideDown(300,"easeInQuad",function(){if(t.yhui.isIE6){var i=e.rightListUp;i.innerHeight()>350?i.height(350):i.css("height","auto")}})},_rightListHide:function(){this.sArrow&&this.sArrow.removeClass("ui-icon-circle-triangle-n"),this.rightList&&this.rightList.slideUp(100)},_addItemToRightList:function(e,i){t("<li>"+e+"</li>").attr({title:e,"data-yhui-tabId":i,role:"data-yhui-tabs-rightlist"}).addClass("yhui-tabs-list-actived ").prependTo(this.rightListUp).siblings("li").removeClass("yhui-tabs-list-actived")},_removeItemFromRightList:function(t){var e=this.active[0].getAttribute("aria-controls");this.rightListUp.find("li[data-yhui-tabId='"+t+"']").eq(0).remove(),this.rightListUp.find("li[data-yhui-tabId='"+e+"']").eq(0).addClass("yhui-tabs-list-actived").siblings("li").removeClass("yhui-tabs-list-actived")},_contextMenu:function(){var e=this,i={"刷新当前":function(t,i){var s=e._getContextMenuTab(i);s[0]===e.active[0]&&e.refreshActive()},"关闭当前":function(i,s){var a=e._getContextMenuTab(s);a.find("span.yhui-tabs-close").eq(0).trigger("click")&&t(document.body).trigger("click")},"关闭其他":function(t,i){e._closeOthers(i)},"关闭全部":function(){e._closeAll()}};e.tabs.eq(0).on("contextmenu",function(t){t.stopPropagation()}),e.tablist.eq(0).yhContextMenu({menu:i,width:100,beforeShow:function(i,s){var a=e._getContextMenuTab(s.target),n=a[0].getAttribute("aria-controls");return"ul"===s.target.nodeName.toLowerCase()?!1:(2===e.tabs.length?t(this).yhContextMenu("disableItem",2):t(this).yhContextMenu("isItemDisable",2)&&t(this).yhContextMenu("enableItem",2),t("#"+n).is(":hidden")?t(this).yhContextMenu("disableItem",0):t(this).yhContextMenu("isItemDisable",0)&&t(this).yhContextMenu("enableItem",0),void 0)}})},_getContextMenuTab:function(e){return t(e).closest("li")},_closeAll:function(){var e=this;this._beforeCloseCheck(),this.tabs.not(":first").each(function(){e._removeTab(t(this),!0)}),this.refresh()},_closeOthers:function(e){var i,s=this;if(this._beforeCloseCheck(),i=this._getContextMenuTab(e),this.tablist.find("li:first")[0]!==this.active[0]){i.siblings("li").not(":first").each(function(){s._removeTab(t(this),!0)}),s.refresh();var a=s._getIndex(i[0].getAttribute("aria-controls"));s.option("active",a)}else this._closeAll()},_beforeCloseCheck:function(){this._arrowVisible()&&0>=parseInt(this.tablist.eq(0).css("left"),10)&&(this.tablist.css("left",0).animate({left:"100px"}).animate({left:0}),this.animated=!1,this._arrowFadeOut())},_eventHandler:function(t){this._super(t),this.rightListUp&&this.rightListUp.find("li[data-yhui-tabid = '"+this.active[0].getAttribute("aria-controls")+"']").addClass(this._consts.LISTACTIVED).siblings().removeClass(this._consts.LISTACTIVED)},_timeOutIframeLoaded:function(e,i){var s=this;e.length&&e.on(s._parseEventType("load"),function(){if(s.options.showLoading&&(clearTimeout(s.standTimer),clearTimeout(s.timer),s._timeOutEnd()),i)try{t(this.contentWindow.document).on(s._parseEventType("click"),function(){s._rightListHide()})}catch(e){}})},_timeOutStart:function(){var t=this;t.loading.on("dialogbeforeclose",function(){return confirm("确定要取消加载吗？")?(clearTimeout(t.standTimer),clearTimeout(t.timer),t._removeTab(t.active),void 0):!1}),t.standTimer=setTimeout(function(){t.loading.dialog("open"),t.timer=setTimeout(function(){var e=t.loading;e.length&&(e.off("dialogbeforeclose"),e.dialog("isOpen")&&e.dialog("close")),t._removeTab(t.active),alert("抱歉，页面加载超时，请尝试重新打开！")},t.options.timeOut)},this.options.standTimeout)},_timeOutEnd:function(){this.loading.off("dialogbeforeclose"),this.loading.dialog("isOpen")&&this.loading.dialog("close")},update:function(){this._addTabCheck(),this._removeTabCheck(!0)},refreshActive:function(){var e=this._getPanelForTab(this.active).find("iframe");e.length?e[0].contentWindow.location.reload(!0):t.yhDialogTip&&t.yhDialogTip.alert?t.yhDialogTip.alert("当前选项卡没有需要刷新的内容。","温馨提示"):alert("当前选项卡没有需要刷新的内容！")},activeDefault:function(){this.rightListUp.find("li").last().trigger("click")},add:function(e){if(e){var i=e.title||"选项卡",s=e.id||this._consts.TABID+t.now(),a=e.src||"",n=e.close||!1,o=e.callback||null,r=t(this._consts[n?"CTAB":"TAB"].replace(/\{href\}/,s).replace(/\{title\}/g,i)),h=t("<div id = '"+s+"'></div>");if(this.tablist.append(r),(this.container?this.container:this.element).append(h),a){var l=t("<iframe frameborder='0' style = 'width: 100%; height: 100%'></iframe>").appendTo(h);l[0].src=a,this._timeOutIframeLoaded(l,e.capture)}this.refresh(),this.option("active",this._getIndex(s));var d={tab:r,panel:h};o&&o.call(this.element,d),this._trigger("add",null,d)}}})})(jQuery);