/*!
* yhui 1.3.0beta
* jquery.yhMenu.js
* 2013-04-23
*/
(function(t){var e,i={},s={},a=0;t.widget("yhui.yhMenu",{version:"1.3.0beta",options:{durationIn:80,durationOut:10,timeToIn:300,url:"",beforeInit:null,onClick:t.noop},_consts:{id:{ID:"_yhmenu_",A:"_a",SPAN:"_span",UL:"_ul"}},_create:function(){e=this,this.element.addClass("yhui-menu-firstul ui-helper-clearfix").empty(),this.menuId=this.element[0].id,this._ajaxData()},_parse:function(e){var i,s;null!==e&&(i=t.yhui.clone(e)),this._root.initRoot(this.menuId),s=this._root.getRoot(this.menuId),s.children=i,this._cache.initCache(this.menuId),this._event.bindEvent(this.menuId),s.children&&s.children.length>0&&this._view.createNodes(this.menuId,0,s.children)},_data:{initNode:function(t,i,s,n,o,r){s&&(s.level=i,s.mId=t+e._consts.id.ID+ ++a,s.parentMId=n?n.mId:null,s.children&&s.children.length>0&&(s.isParent=!0),s.isFirstNode=o,s.isLastNode=r)},addNodeCache:function(t,i){e._cache.getCache(t).nodes[i.mId]=i},getNodeCache:function(t,e){if(!e)return null;var s=i[t].nodes[e];return s?s:null}},_view:{createNodes:function(t,i,s,a){if(s&&0!==s.length){var n=e._root.getRoot(t),o=this.appendNodes(t,i,s,a,!0,!0);n.createdNodes=[],e.element.append(o.join(""))}},appendNodes:function(t,i,s,a,n,o){if(!s)return[];for(var r=[],l=0,h=s.length;h>l;l++){var d=s[l],c=a?a:e._root.getRoot(t),u=c.children,f=u.length==s.length&&0==l,p=l==s.length-1;e._data.initNode(t,i,d,a,f,p),e._data.addNodeCache(t,d),d.children&&d.children.length>0&&e._view.appendNodes(t,i+1,d.children,d,n,!1),o&&(r.push("<li id='",d.mId,"' class='yhui-menu-firstli ",this.isShowRightArrow(d)?0:"yhui-menu-aligncenter"," level",d.level,"' ><a id='",d.mId+e._consts.id.A,"' >",d.name,"</a>"),this.isShowRightArrow(d)&&r.push("<span>»</span>"),r.push("</li>"))}return r},isShowRightArrow:function(t){return t.isParent},expandNode:function(t,i){var s=[],a=0===t.level?"":"yhui-menu-thiul";s.push("<ul id='",t.mId+e._consts.id.UL,"' class = 'yhui-menu-secul ",a," level",t.level,"' >");for(var n=0,o=i.length;o>n;n++){var r=i[n],l="";r.name.length>10&&(l="title='"+r.name+"'"),s.push("<li "+l+" id = '",r.mId,"' class = 'level",r.level,"' >"),s.push("<a id = '",r.mId+e._consts.id.A,"' >",r.name,"</a>"),this.isShowRightArrow(r)&&s.push("<span>»</span>"),s.push("</li>")}return s.push("</ul>"),s},fixIE6:function(e,i,s){var a=0===i?"yhui-menu-firhover":"yhui-menu-seclihover";return s?(t(e).removeClass(a),void 0):(0===i?t(e).addClass(a).children("a").addClass("hover").siblings("li").removeClass(a).children("a").removeClass("hover"):t(e).addClass(a).siblings("li").removeClass(a),void 0)}},_root:{initRoot:function(t){var e=this.getRoot(t);e||(e={},this.setRoot(t,e)),e.children=[],e.createdNodes=[]},getRoot:function(t){return t?s[t]:null},setRoot:function(t,e){s[t]=e}},_cache:{initCache:function(t){var e=this.getCache(t);e||(e={},this.setCache(t,e)),e.nodes=[],e.doms=[]},getCache:function(t){return t?i[t]:null},setCache:function(t,e){i[t]=e}},_event:{bindEvent:function(){e.element.off(".yhmenu",this.proxy),e.element.off("mouseleave",this.proxy),e.element.on("click.yhmenu",this.proxy),e.element.on("mouseenter.yhmenu","li",this.proxy),e.element.on("mouseleave.yhmenu","li",this.proxy),e.element.on("dbclick.yhmenu","li",function(){return!1}),e.element.on((t.support.selectstart?"selectstart":"mousedown")+".yhmenu","li",function(t){t.preventDefault()})},proxy:function(i){var s=this,a=e._data.getNodeCache(e.menuId,s.id);switch(i.type){case"mouseenter":t.yhui.isIE6&&e._view.fixIE6(s,a.level),e._event.timer=e._event.delayTrigger(function(){e._event.mouseEnterEvent(i,s,a)},e.options.timeToIn);break;case"mouseleave":t.yhui.isIE6&&e._view.fixIE6(s,a.level,!0),clearTimeout(e._event.timer),e._event.mouseLeaveEvent(i,s,a);break;case"click":e._event.mouseClick(i)}},mouseEnterEvent:function(i,s,a){var n,o=t(s).children("ul");a&&a.isParent&&(n=e._view.expandNode(a,a.children),o.length?(t(s).siblings("li").children("ul").fadeOut(10),0===a.level?o[t.yhui.isIE6?"fadeIn":"slideDown"](e.options.durationIn):o.css("display","block")):0===a.level?t(s).append(n.join("")).children("ul")[t.yhui.isIE6?"fadeIn":"slideDown"](e.options.durationIn):t(s).append(n.join("")).children("ul").css("display","block"))},mouseLeaveEvent:function(i,s,a){var n=t(s).children("ul");n.length&&n.is(":visible")&&(0===a.level?n[t.yhui.isIE6?"fadeOut":"slideUp"](e.options.durationOut):n.css("display","none"))},mouseClick:function(t){if(t.target.id!==e.menuId){var i=e._getLiDom(t.target),s=e._data.getNodeCache(e.menuId,i.id),a={menu:e.element,node:s};return s.isParent?!1:(e.options.onClick&&e.options.onClick.call(i,t,a),void 0)}},delayTrigger:function(t,e){return setTimeout(t,e)}},_ajaxData:function(){var e=this;this.options.url&&t.ajax({url:e.options.url,dataType:"json",success:function(t){var i={data:t};e._trigger("beforeInit",null,i),e._parse(t)},error:function(e,i){t.yhui.log(i)}})},_getLiDom:function(e){return"li"!==e.nodeName.toLowerCase()?t(e).closest("li")[0]:e}})})(jQuery);