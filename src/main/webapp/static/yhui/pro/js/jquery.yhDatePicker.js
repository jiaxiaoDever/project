/*!
* yhui 1.3.0beta
* jquery.yhDatePicker.js
* 2013-04-23
*/
(function(e){var t=0,i=null;e.widget("yhui.yhDatePicker",{version:"1.3.0beta",defaultElement:"<input>",options:{format:"yyyy-MM-dd",maxDate:null,minDate:null,selectedDate:null,showTime:!1,hide:null},_CONSTS:{TF:"HH:mm:ss",ROW:6,COL:7,DISABLE:"yhui-datepicker-disable",TODAY:"yhui-datepicker-today",WBEGIN:"yhui-datepicker-weekbegin",WEND:"yhui-datepicker-weekend",PMON:"yhui-datepicker-prevmonth",CMON:"yhui-datepicker-currentmonth",NMON:"yhui-datepicker-nextmonth",SELECTED:"yhui-datepicker-selecteddate",TIME:"yhui-datepicker-time",dayNames:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},_create:function(){var e=this;this.id="yhui-datepicker-"+t++,this.element.val("").addClass("yhui-form-text yhui-datepicker-holder").attr("hasDatePicker",this.id).on(e._namespace("focus"),function(){e._parse()}),this._parseData(),this.options.selectedDate&&this._setValue()},_parse:function(e){this._parseDom(),e||this.show()},_parseData:function(){var e=new Date,t=this._parseDate(this.options.selectedDate,e),i=null,s=null;t&&("string"==typeof t?i=Globalize.parseDate(t,this.options.format):t.getTime&&(i=t)),i&&(e=this._cloneDate(i)),this.options.showTime&&(s=this._parseTimeData()),this.info={drawDate:e,selectedDate:i,today:new Date,time:s}},_parseTimeData:function(){var e=null,t=this.options.showTime,i=typeof t,s=new Date;if("boolean"===i)e=new Date(0,0,0,s.getHours(),s.getMinutes(),s.getSeconds());else if("string"===i){var a=t.split(":");1===a.length&&(this.disableMinutes=!0,this.disableSeconds=!0,e=new Date(0,0,0,a[0],0,0)),2===a.length&&(this.disableSeconds=!0,e=new Date(0,0,0,a[0],a[1],0)),3===a.length&&(e=new Date(0,0,0,a[0],a[1],a[2]))}return e},_parseDom:function(){this.hasDatePicker||(this._createFrame(),this._events(),this._refresh())},_events:function(){var t=this;this.window.on(this._namespace("resize"),function(){t._updatePosition()}),this.document.on(this._namespace("click"),function(){t.datepicker.is(":visible")&&t.hide()}),this.element.on(this._namespace("click"),function(e){e.stopPropagation()}),this.datepicker.on(this._namespace("click"),function(i){var s=e(i.target).attr("role");/^(?:yearinput|monthinput|yearprev|yearnext)$/.test(s)||t._closeList(),i.stopPropagation()}).on(this._namespace("mousewheel"),function(e,i){t.options.showTime&&(t._refreshTime(i),t.changeTime=!0)}).on(this._namespace("mousedown mouseup"),"a,td",function(i){if(!(this.className.indexOf("disable")>-1)){var s=e(this),a=s.attr("role");switch(a){case"prev":case"next":case"yearprev":case"yearnext":s.toggleClass("yhui-state-actived");break;case"today":s.toggleClass("yhui-datepicker-btntoday-hover");break;case"step":t._step(i,this,this.className.indexOf("up")>-1?1:-1)}}}).on(this._namespace("mouseenter mouseleave"),"a,td,div,input:not([disabled])",function(i){if(!(this.className.indexOf("disable")>-1)){var s=e(this),a=s.attr("role");switch(a){case"prev":case"next":s.toggleClass("yhui-state-hover"),"mouseleave"===i.type&&s.removeClass("yhui-state-actived");break;case"calendar":case"yearlist":case"monthlist":case"yearprev":case"yearnext":case"hour":case"second":case"minute":case"step":if(("monthlist"===a||"yearlist"===a)&&s.hasClass("yhui-state-actived"))return;s.toggleClass("yhui-state-hover");break;case"close":"mouseleave"===i.type&&t._closeList();break;case"today":s.toggleClass("yhui-datepicker-btntoday-hover")}}}).on(this._namespace("keydown"),"input",function(e){e.preventDefault()}).on(this._namespace("click"),"a,td,input:not([disabled]),button",function(i){if(i.preventDefault(),!(this.className.indexOf("disable")>-1)){var s=e(this),a=s.attr("role");switch(a){case"next":case"prev":var n="next"===a?1:-1;t._adjust(t.info.drawDate,n),t._refresh();break;case"today":t._today();break;case"calendar":t._calendar(this);break;case"monthinput":t._monthinput();break;case"yearinput":t._yearinput();break;case"monthlist":t._monthlist(this);break;case"yearlist":t._yearlist(this);break;case"yearprev":case"yearnext":var o="yearprev"===a,r=o?-5:6,h=t.yearlist.find("tr:last>td")[o?"first":"last"]().text();t._yearinput(parseInt(h)+r);break;case"clear":t._clear();break;case"confirm":if(t.options.showTime&&t.changeTime&&t._setValue()===!1)return;t.hide(),t.element.blur();break;case"hour":case"minute":case"second":e(this).addClass("yhui-datepicker-focus").siblings("input").removeClass("yhui-datepicker-focus");break;default:}}})},_namespace:function(t){return e.yhui.parseEventType(t,this.eventNamespace)},_cloneDate:function(e){return e?new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds()):void 0},_refresh:function(){this._refreshHeader(),this._refreshMain(),this.options.showTime&&this._refreshTimePicker()},_refreshHeader:function(){var e=this.info.drawDate.getFullYear(),t=this.info.drawDate.getMonth();this.yearinput.val(e),this.monthinput.val(this._CONSTS.monthNames[t])},_refreshMain:function(){var e,t,i,s=0,a=0,n=0,o=-1,r=!1,h=["<table><thead><tr>"],l=this.info,d=l.drawDate.getMonth(),c=l.drawDate.getFullYear(),u=l.today.getDate(),p=this._parseDate(this.options.minDate,l.selectedDate||l.today),f=this._parseDate(this.options.maxDate,l.selectedDate||l.today),m=this._firstDayOfMonth(c,d),v=this._daysInMonth(c,d),g=this._daysInMonth(c,d-1),y=m>0,_=this._CONSTS;for(this._checkedPrevOrNext(c,d);_.COL>s;s++)h.push("<th>",_.dayNames[s],"</th>");for(h.push("</tr></thead><tbody>");_.ROW>a;a++){for(h.push("<tr>"),i=0;_.COL>i;i++){y?(t=_.PMON,e=g-m+i+1,o=d-1):r?(t=_.NMON,e=++n,o=d+1):(t=_.CMON,e=++n,o=d);var b=new Date(c,o,e).getTime();p&&p.getTime()>b&&(t=t+" "+_.DISABLE),f&&b>f.getTime()&&(t=t+" "+_.DISABLE),0===i&&(t=t+" "+_.WBEGIN),6===i&&(t=t+" "+_.WEND),u!==n||y||r||l.today.getMonth()!==d||l.today.getFullYear()!==c||(t=t+" "+_.TODAY),l.selectedDate&&n===l.selectedDate.getDate()&&!r&&(t=t+" "+_.SELECTED),h.push("<td role='calendar' class = '"+t+"'>",e,"</td>"),e===g&&(y=!1),n>=v&&(n=0,r=!0)}h.push("</tr>")}h.push("</tbody></table>"),this.main.html(h.join(""))},_refreshTimePicker:function(){var t=this.info.time,i=this.timepicker.find("input");t&&(this.disableSeconds&&i.eq(2).prop("disabled",!0),this.disableMinutes&&i.eq(1).prop("disabled",!0),e.each(Globalize.format(t,this._CONSTS.TF).split(":"),function(e,t){i.eq(e).val(t)}))},_refreshTime:function(e){var t=this.info.time,i=this.timepicker.find("input.yhui-datepicker-focus"),s=i.attr("role"),a=parseInt(i.val(),10),n=function(e){return e+="",1===e.length?"0"+e:e};switch(a+=e,s){case"hour":a>23&&(a=0),0>a&&(a=23),t.setHours(a);break;case"minute":case"second":a>59&&(a=0),0>a&&(a=59),t["minute"===s?"setMinutes":"setSeconds"](a)}i.val(n(a))},_step:function(t,i,s){var a=this;"mousedown"===t.type?(e(i).addClass("yhui-state-actived"),this._repeat(null,function(){a._refreshTime(s)})):(clearTimeout(this.timer),e(i).removeClass("yhui-state-actived"))},_repeat:function(e,t){e=e||500;var i=this;i.timer=i._delay(function(){i._repeat(100,t)},e),t&&t.apply(null,arguments)},_createFrame:function(){this.datepicker=e("<div id = '"+this.id+"' class = 'yhui-datepicker'>"+"<div class = 'yhui-datepicker-head' >"+"<a href = '#' class = 'yhui-datepicker-prev' role = 'prev' ><span class = 'ui-icon ui-corner-all ui-icon-triangle-1-w' ></span></a>"+"<input role = 'yearinput' type = 'text' class = 'yhui-datepicker-changeyear' />"+"<span class = 'yhui-datepicker-split'></span>"+"<input role = 'monthinput' type = 'text' class = 'yhui-datepicker-changemonth' />"+"<a href = '#' class = 'yhui-datepicker-next' role = 'next' ><span class = 'ui-icon ui-corner-all ui-icon-triangle-1-e' ></span></a>"+"<a href = '#' class = 'yhui-datepicker-btntoday' role = 'today'>今天</a>"+"</div><div class = 'yhui-datepicker-main' ></div>"+"<div class = 'yhui-datepicker-control' >"+"<button role = 'confirm'>确定</button><button role = 'clear'>清空</button>"+"</div>"+"</div>").hide().appendTo(this.document[0].body);var t=this.datepicker.children("div");this.header=t.first(),this.yearinput=this.header.find(".yhui-datepicker-changeyear").eq(0),this.monthinput=this.header.find(".yhui-datepicker-changemonth").eq(0),this.prev=this.header.find(".yhui-datepicker-prev").eq(0),this.next=this.header.find(".yhui-datepicker-next").eq(0),this.today=this.header.find(".yhui-datepicker-btntoday").eq(0),this.main=t.eq(1),this.buttonPane=t.eq(2),this.datepicker.disableSelection().hide().append(this.header,this.main,this.buttonPane).appendTo(this.document[0].body),this.hasDatePicker=!0,this.options.showTime&&this._createTimePicker()},_createTimePicker:function(){this.timepicker=e("<div class = 'yhui-datepicker-time'><div class = 'yhui-datepicker-timeinner'><input type = 'text' role='hour' class = 'yhui-datepicker-hour yhui-datepicker-focus' /><span>:</span><input type = 'text' role='minute' class = 'yhui-datepicker-minute' /><span>:</span><input type = 'text' role='second' class = 'yhui-datepicker-second' /><a href = '#' class = 'yhui-datepicker-up' role = 'step' ><span class = 'ui-icon ui-icon-triangle-1-n'></span></a><a href = '#' class = 'yhui-datepicker-down' role = 'step' ><span class = 'ui-icon ui-icon-triangle-1-s'></span></a></div></div>").insertBefore(this.buttonPane)},_firstDayOfMonth:function(e,t){return new Date(e,t,1).getDay()},_daysInMonth:function(e,t){return 32-new Date(e,t,32).getDate()},_monthNameToIndex:function(t){return-1===t.indexOf("月")&&(t+="月"),e.inArray(t,this._CONSTS.monthNames)},_parseDate:function(e,t){if(e&&e.getTime)return e;var i=/(?:([\+,-]\d+)y)?(?:([+,-]\d+)M)?(?:([+,-]\d+)d)?/;if(t=t||new Date,"string"==typeof e){if(/y|m|d/i.test(e)){var s=i.exec(e),a=t.getFullYear()+(parseInt(s[1])||0),n=t.getMonth()+(parseInt(s[2])||0),o=t.getDate()+(parseInt(s[3])||0);return-1===e.indexOf("d")&&(o=Math.max(1,Math.min(o,this._daysInMonth(a,n)))),new Date(a,n,o,t.getHours(),t.getMinutes(),t.getSeconds())}return Globalize.parseDate(e,this.options.format)}},_checkedPrevOrNext:function(e,t){var i=this._parseDate(this.options.minDate),s=this._parseDate(this.options.maxDate);if(!i&&!s)return this.prev.add(this.next).removeClass("ui-state-disabled");var a,n,o=new Date(e,t).getTime();i&&(a=new Date(i.getFullYear(),i.getMonth()).getTime(),a===o?this.prev.addClass("ui-state-disabled").removeClass("ui-state-hover"):this.prev.removeClass("ui-state-disabled")),s&&(n=new Date(s.getFullYear(),s.getMonth()).getTime(),n===o?this.next.addClass("ui-state-disabled").removeClass("ui-state-hover"):this.next.removeClass("ui-state-disabled"))},_checkToday:function(){var e=this._parseDate(this.options.maxDate),t=this._parseDate(this.options.minDate),i=new Date,s=new Date(i.getFullYear(),i.getMonth(),i.getDate()).getTime();if(e){if(s>e.getTime())return this.today.addClass("ui-state-disabled"),void 0;this.today.removeClass("ui-state-disabled")}t&&(t.getTime()>s?this.today.addClass("ui-state-disabled"):this.today.removeClass("ui-state-disabled"))},_updatePosition:function(){var e={top:0,left:0};this.datepicker.css(e).position({of:this.element,at:"left bottom",my:"left top",collision:"flipfit"})},_calendar:function(t){var i=0,s=this._CONSTS.SELECTED,a=this.info.drawDate,n=a.getFullYear(),o=a.getMonth();t.className.indexOf("prev")>-1&&(i=-1),t.className.indexOf("next")>-1&&(i=1),this.main.find("td").removeClass(s),e(t).addClass(s),this._adjust(this.info.drawDate,i),this.info.selectedDate=new Date(n,o,t.innerHTML),this._setValue(),i&&this._refresh()},_adjust:function(e,t,i){var s,a,n,o;"number"==typeof t?(s=e.getFullYear(),a=e.getMonth()+t,n=e.getDate(),o=this._daysInMonth(s,a),e.setMonth(a,Math.min(n,o))):"y"===t?(a=e.getMonth(),n=e.getDate(),o=this._daysInMonth(i,a),e.setFullYear(i),e.setMonth(a,Math.min(n,o))):"M"===t&&(s=e.getFullYear(),n=e.getDate(),o=this._daysInMonth(s,i),e.setMonth(i,Math.min(n,o)))},_setValue:function(){var e,t=Globalize.format(this.info.selectedDate,this.options.format);return t?(this.info.time&&(e=Globalize.format(this.info.time,this._CONSTS.TF),t=t+" "+e),this.element.val(t),void 0):(alert("请选择一个日期"),!1)},_today:function(){var e=this.info,t=this.info.today,i=t.getMonth(),s=t.getFullYear();e.selectedDate=this._cloneDate(t),e.drawDate.setFullYear(s),e.drawDate.setMonth(i),this._setValue(),this._refresh()},_monthinput:function(){if(this.monthlist)this.monthlist.show();else{for(var t=["<div role='close' class='yhui-datepicker-month ui-widget-content'><table>"],i=0,s=this._CONSTS.monthNames.length;s>i;i++)i%2||t.push("<tr>"),t.push("<td role='monthlist'>",this._CONSTS.monthNames[i].substring(0,2),"</td>"),(i+1)%2||t.push("</tr>");t.push("</table></div>"),this.monthlist=e(t.join("")).appendTo(this.header).show()}this.monthlist.find("td").removeClass("yhui-state-actived").eq(this.info.drawDate.getMonth()).addClass("yhui-state-actived"),this.header.addClass("yhui-datepicker-focusmonth").removeClass("yhui-datepicker-focusyear"),this.yearlist&&this.yearlist.hide()},_monthlist:function(t){if(!e(t).hasClass("yhui-state-actived")){var i=this._monthNameToIndex(t.innerHTML);this._adjust(this.info.drawDate,"M",i),this._refresh(),this._closeList()}},_yearinput:function(t){if(this.yearlist)this.yearlist.find("div").html(this._createYearList(t)).end().show();else{var i="<div role='close' class = 'yhui-datepicker-year ui-widget-content'><div>"+this._createYearList()+"</div>"+"<a href = '#' role = 'yearprev' class = 'yhui-datepicker-yearprev'>&larr;</a>"+"<a href = '#' role = 'yearnext' class = 'yhui-datepicker-yearprev'>&rarr;</a>"+"</div>";this.yearlist=e(i).appendTo(this.header).show()}this.header.addClass("yhui-datepicker-focusyear").removeClass("yhui-datepicker-focusmonth"),this.monthlist&&this.monthlist.hide()},_yearlist:function(t){if(!e(t).hasClass("yhui-state-actived")){var i=parseInt(t.innerHTML,10);this._adjust(this.info.drawDate,"y",i),this._refresh(),this._closeList()}},_createYearList:function(e){for(var t=0,i=e||this.info.drawDate.getFullYear(),s=["<table>"];5>t;t++)s.push("<tr>"),s.push("<td role='yearlist'>",i-t-1,"</td>"),s.push("<td"),0===t&&i===this.info.drawDate.getFullYear()&&s.push(" class='yhui-state-actived'"),s.push(" role='yearlist'>",i+t,"</td>"),s.push("</tr>");return s.push("</table>"),s.join("")},_clear:function(){this.hide(),this.element.val("").blur(),this._parseData(),this._refresh()},_setOption:function(e,t){return this.datepicker||this._parse(!0),"selectedDate"===e?(this.options.selectedDate=t,this._parseData(),this._refresh(),this._setValue(),void 0):(this._super(e,t),("minDate"===e||"maxDate"===e)&&this._refresh(),void 0)},show:function(){this._checkToday(),this.datepicker.show(),this.justShow||(this._updatePosition(),this.justShow=!0),i&&i.id!==this.id&&i.hide(),i&&i.id===this.id||(i=this)},_closeList:function(){this.monthlist&&this.monthlist.hide(),this.yearlist&&this.yearlist.hide(),this.header.removeClass("yhui-datepicker-focusmonth yhui-datepicker-focusyear")},hide:function(){this._closeList(),this.datepicker.hide(),this._delay(function(){this._trigger("hide",null,{input:this.element})},20)},_destroy:function(){this.element.removeClass("yhui-datepicker-holder").removeAttr("hasDatePicker").off(this.eventNamespace),this.datepicker&&this.datepicker.off(this.eventNamespace).remove()},getSelected:function(){var e,t=this.info.selectedDate;return(e=this.info.time)&&(t.setHours(e.getHours()||0),t.setMinutes(e.getMinutes()||0),t.setSeconds(e.getSeconds()||0)),t}})})(jQuery);