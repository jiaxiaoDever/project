/*!
* yhui 1.3.0beta
* jquery.yhDropDown.js
* 2013-04-23
*/
(function(t){function e(){return i++}var i=1,s=window.document;t.widget("yhui.yhDropDown",{version:"1.3.0beta",options:{autocomplete:!1,checkbox:!1,chkboxType:null,customContent:"请选择",dataType:"json",disable:!1,height:!1,hiddenId:"",idKey:"",inputWidth:!1,json:null,minLength:1,maxWidth:300,maxHeight:250,noChild:!1,pIdKey:"",post:"",postData:null,resizable:!1,selectAllSelected:!1,selectParent:!1,showButton:!0,simpleData:!1,showPath:!1,type:"post",url:"",width:!1,zTreeSettings:null,beforeClick:null,beforeCreatedTree:null,createdTree:null,hide:null,onClick:null},_consts:{ID:{DROPUL:"yhDropTree_",DROPDIV:"yhDropDiv_",ALLINPUT:"dropDownSeleAll_",DROPDOWN:"yhui-dropdown-"},CLASS:{DROPUL:"ztree yhui-dropdown-tree",DROPDIV:"yhui-dropdown-drop",PARENTDIV:"yhui-dropdown",ALLDIV:"dropDownAll"},BTNSTRING:'<a class = "yhui-btn" href="javascript:void(0)"><span class = "yhui-form-icon classHolder"></span>textHolder</a>'},_create:function(){this._parse(),this._events()},_init:function(){this.firstFlag&&this.__parseDrop()},_parse:function(){var i=this.serial=e(),s=this,n=this.options,a=this.element[0].id||"yhui-dropdown-holder-"+i;this.element.attr("id",a).val("").css("border","none").width(n.inputWidth?n.inputWidth:150).wrap('<div id = "'+s._consts.ID.DROPDOWN+i+'" class = "'+s._consts.CLASS.PARENTDIV+'"></div>'),this.parent=this.element.parent(),this.arrow=t('<a href="#" id="yhui-dropdown-arrow_'+i+'" class = "yhui-dropdown-arrow"></a>').appendTo(this.parent),n.post&&(this.hidden=t('<input type = "hidden" name = "'+(n.hiddenId?n.hiddenId:"yhui-dropdown-hide_"+i)+'" id = "'+(n.hiddenId?n.hiddenId:"yhui-dropdown-hide_"+i)+'" />').appendTo(this.parent)),this.disabledDiv=t('<div class = "yhui-dropdown-disabled"></div>').appendTo(this.parent),t.yhui.isIE6?setTimeout(function(){s.options.disable&&s.disable()},10):s.options.disable&&s.disable();var o=this._consts.ID.DROPUL+i;this.element.data("treeId",o),this.element.siblings("input:hidden").data("treeId",o)},_parseDrop:function(){var e=this.serial,i=this.options;if(this.dropDiv=t('<div id = "'+this._consts.ID.DROPDIV+e+'" class = "'+this._consts.CLASS.DROPDIV+'"></div>').width(this.element.width()).hide(),t.data(this.dropDiv[0],this.widgetName,this),(!i.noChild||i.checkbox)&&i.showButton&&!i.showPath){this.buttonPanel=t('<div class = "yhui-dropdown-buttonpanel"></div>').appendTo(this.dropDiv);var n=this._consts.BTNSTRING.replace(/classHolder/,"yhui-btn-selectall"),a=this._consts.BTNSTRING.replace(/classHolder/,"yhui-btn-unselectall").replace(/textHolder/,"全选");i.checkbox||t(n.replace(/textHolder/,"清空")).appendTo(this.buttonPanel),i.checkbox&&t(a).add(t(n.replace(/textHolder/,"全不选"))).appendTo(this.buttonPanel)}this.dropUl=t('<ul id = "'+this._consts.ID.DROPUL+e+'" class = "'+this._consts.CLASS.DROPUL+'"></ul>').appendTo(this.dropDiv),this.dropDiv.appendTo(s.body),this._bindDropEvent()},__parseDrop:function(){this.firstFlag||(this.dropUl||this.dropDiv)&&this.options.height&&this.options.height>200&&this.dropDiv.css("maxHeight","none").height(this.options.height),this.tree&&this.tree.destroy(),this.options.json&&!this.options.postData||!this.options.url.length?this._initTree(this.serial,this.options):this._getData(),this.firstFlag=!0},_events:function(){var e=this,i=function(i){return t.yhui.parseEventType(i,e.eventNamespace)};e._documentClickHide(),e.parent.on(i("focusin click"),"[type=text]",function(t){"click"===t.type&&t.preventDefault(),"focusin"===t.type&&e._showDrop()}).on(i("click"),"a",function(t){t.preventDefault(),e.dropDiv&&e.dropDiv.is(":visible")?e._hideDrop():e.element[0].focus()}),this.window.on(i("resize"),function(){e._hideDrop(),e.notUpdatePosition=!1})},_bindDropEvent:function(){var e=this,i=function(i){return t.yhui.parseEventType(i,e.eventNamespace)};if(e.dropDiv.on(i("mouseleave"),function(){e._hideDrop()}),this.buttonPanel){var s=this.buttonPanel.find("a");1===s.length?s.eq(0).on(i("click"),function(){e.element[0].value="",e.hidden&&(e.hidden[0].value="");var i=t.yhGetTree("yhDropTree_"+e.serial);return i&&i.cancelSelectedNode(),!1}):2===s.length&&this.buttonPanel.on(i("click"),"a",function(){var i=this.lastChild.data,s=t.yhGetTree("yhDropTree_"+e.serial);return"全选"===i&&e._selectedAll(s,!0),"全不选"===i&&e._selectedAll(s,!1),!1})}},_initTree:function(e,i,s){var n=this,a={check:{enable:!1},view:{dblClickExpand:!1},data:{simpleData:{}},callback:{beforeClick:function(t,e){return i.checkbox?n._checkBeforeClick(t,e,i.selectParent,i):n._defaultBeforeClick(t,e,i.selectParent,i)},onClick:function(t,e,s){i.checkbox||n._defaultOnClick(t,e,s,i)},onCheck:function(t,e,s){i.showPath&&!i.noChild?n._showPathCheck(t,e,s):n._defaultOnCheck(t,e,s,i)}}};(t.yhui.isIE6||t.yhui.isIE8)&&(a.callback.onExpand=function(){var t=n.dropUl.height();t>200&&n.dropUl.height(200)},a.callback.onCollapse=function(){var t=n.dropUl.find("li:last"),e=t.offset().top+t.outerHeight();201>e&&n.dropUl.css("height","auto")}),i.checkbox&&(a.check.enable=!0),i.checkbox||(a.view.selectedMulti=!1),i.chkboxType&&("Y"in i.chkboxType||"N"in i.chkboxType)&&(a.check.chkboxType=i.chkboxType),i.noChild&&(a.view.showIcon=!1,a.view.showLine=!1),i.simpleData&&(a.data.simpleData.enable=!0,i.pIdKey&&(a.data.simpleData.pIdKey=i.pIdKey),i.idKey&&(a.data.simpleData.idKey=i.idKey)),i.zTreeSettings&&t.extend(!0,a,i.zTreeSettings),i&&i.json&&this._trigger("beforeCreatedTree",s,{data:i.json,zTreeSettings:a});var o=t.yhui.clone(i.json);if(i.noChild&&i.customContent){var r={name:i.customContent};i.post&&(r[i.post]=""),!i.checkbox&&t.isArray(o)&&o.unshift(r)}t("#yhDropTree_"+e).yhTree(a,o);var h=this.tree=t.yhGetTree("yhDropTree_"+e);if(i.noChild)for(var l=h.getNodes(),d={display:"inline-block",width:i.checkbox?t.yhui.isIE67?"72%":"80%":t.yhui.isIE67?"98%":"100%",overflow:"hidden","text-overflow":"ellipsis"},c=0,u=l.length;u>c;c++)t("#"+l[c].tId).children("span:first").hide().end().children("a").css(d);if(this.dropDiv&&this.options.width){var p=this.options.width;this.dropDiv.width(p),this.options.noChild&&this.dropUl.find("a").width(this.options.checkbox?t.yhui.isIE67?p-46:p-30:p-15)}if(t.yhui.isIE6){var f=this.dropDiv.width()-10;this.dropUl.css("width",f+"px")}if(i.linkage){var m=h.getNodeByParam("name","请先选上一级");m&&t("#"+m.tId+"_ico").hide()}if(i.selectAllSelected&&i.noChild&&this._selectedAll(h,!0),this._trigger("createdTree",s,h),i.autocomplete){var v=h.transformToArray(h.getNodes());this._autocomplete(h,v)}i.resizable&&this._resizable()},_autocomplete:function(e,i){var s=this,n=s.options;t.ui.autocomplete.filter=function(e,i){var s=RegExp(t.ui.autocomplete.escapeRegex(i),"i");return t.grep(e,function(t){return s.test(t.name)})},n.checkbox||n.noChild||this.element.on("keydown",function(i){!e.getSelectedNodes().length||i.keyCode!==t.ui.keyCode.BACKSPACE&&i.keyCode!==t.ui.keyCode.DELETE||1>=this.value.length&&e.cancelSelectedNode()}).autocomplete({source:i,messages:null,minLength:n.minLength,key:e.setting.data.key.name,open:function(){s._hideDrop()},position:{of:s.parent},select:function(i,s){if(this.value=s.item.name,n.post&&(t(this).siblings("input:hidden")[0].value=s.item[n.post]),s.item[n.post]){var a=e.getNodeByParam(n.post,s.item[n.post]);a&&e.selectNode(a)}return!1}})},_resizable:function(){var t=!1,e=this.buttonPanel.outerHeight(),i=this;this.dropDiv.resizable({helper:"ui-resizable-helper",maxHeight:this.options.maxHeight,minHeight:100,maxWidth:this.options.maxWidth,minWidth:this.dropDiv.outerWidth(),resize:function(s,n){t||(i.dropUl.css("maxHeight",i.options.maxHeight),t=!0),i.dropUl.height(n.size.height-e-13)},start:function(){i.preventHide=!0},stop:function(){delete i.preventHide}})},_updatePosition:function(){if(!this.notUpdatePosition){var t={top:0,left:0};this.dropDiv.css(t).position({of:this.parent,my:"left top-1",at:"left bottom",collision:"flipfit"}),this.notUpdatePosition=!0}},_showDrop:function(){if(this.dropDiv||(this._parseDrop(),this.__parseDrop()),this.dropDiv.show(),this._updatePosition(),t.yhui.isIE6||t.yhui.isIE8){var e=this.dropUl.height();e>200&&this.dropUl.height(200)}},_documentClickHide:function(){var e=this;e.document.on("click"+e.eventNamespace,function(i){var s=i.target,n=t(s),a=e.dropDiv;a&&a.is(":visible")&&(n.closest(e.dropDiv).length>0||n.closest("div.ui-dialog").length>0||n.closest(e.parent).length>0||e._hideDrop())})},_hideDrop:function(){if(this.dropDiv){this.preventHide||this.dropDiv.hide(),this.element.blur();var t={dropDiv:this.dropDiv,dropDown:this};this._trigger("hide",null,t)}},_defaultBeforeClick:function(e,i,s,n){var a=t.yhGetTree(e);return n.beforeClick&&n.beforeClick.call(this,a,i),s?void 0:(i.isParent&&a.expandNode(i,!i.open,null,null,!0),!i.isParent)},_checkBeforeClick:function(e,i,s,n){var a=t.yhGetTree(e);return n.beforeClick&&n.beforeClick.call(this,a,i),a.checkNode(i,!i.checked,!0,!0),!1},_defaultOnClick:function(e,i,s,n){var a=t.yhGetTree(i),o=this,r={tree:a,node:s,input:o.element,hidden:o.hidden,dropDiv:o.dropDiv};if(o._trigger("onClick",null,r)!==!1){var h=a.getSelectedNodes(),l=h[0].name,d="";n.post&&(d=h[0][n.post]),o._bindData(null,l,d,i,n),o._hideDrop()}},_defaultOnCheck:function(e,i,s,n){var a=t.fn.zTree.getZTreeObj(i),o=a.getCheckedNodes(!0),r=this,h={tree:a,node:s,nodes:o,input:r.element,hidden:r.hidden,dropDiv:r.dropDiv};if(r._trigger("onClick",null,h)!==!1){for(var l="",d="",c=0,u=o.length;u>c;c++)l+=o[c].name+",",n.post&&(d+=o[c][n.post]+",");r._bindData(o,l,d,i,n)}},_showPathCheck:function(e,i,s){for(var n=t.fn.zTree.getZTreeObj(i),a=n.getCheckedNodes(!0),o=[],r=[],h=this,l=0,d=a.length,c=function(t){var e=t.getParentNode().getCheckStatus();return e.checked&&e.half},u=function(t){for(var e=[],i=[];t&&t.level>=0;)e.unshift(t.name?t.name:""),h.options.post&&i.unshift(t[h.options.post]?t[h.options.post]:""),t=t.getParentNode();return{name:e.join("/"),post:i.join("/")}},p=function(t){for(;!c(t);)if(t=t.getParentNode(),0===t.level&&t.getCheckStatus().checked&&!t.getCheckStatus().half)return t;return t},f=function(e){0>t.inArray(e.name,o)&&o.push(e.name),h.options.post&&0>t.inArray(e.post,r)&&r.push(e.post)};d>l;l++)a[l].isParent||0===a[l].level||(c(a[l])?f(u(a[l])):f(u(p(a[l]))));h.element.val(o.join(",")),h.element.siblings("input").eq(0).val(r.join(";"));var m={tree:n,node:s,dropDiv:n.setting.treeObj.parent()};h._trigger("onClick",null,m)},_bindData:function(t,e,i,s,n){var a=this.element,o=this.element.siblings("input:hidden").eq(0);return n.checkbox&&!t.length?(a.val(""),o.val(""),void 0):(0>e.indexOf(",")?(a.val(e),null!=i&&o.val(i)):(e.length>0&&(e=e.substring(0,e.length-1),a.val(e)),i.length>0&&(i=i.substring(0,i.length-1),o.val(i))),void 0)},_selectedAll:function(t,e){for(var i=t.transformToArray(t.getNodes()),s=0,n=i.length;n>s;s++)t.checkNode(i[s],e,null,!0)},_getData:function(){var e=this;t.yhui.yhLoading&&this.parent.yhLoading({size:"small",duration:200}),t.ajax({url:e.options.url,dataType:e.options.dataType,data:e.options.postData,type:e.options.type,success:function(i){e.options.json=i,e._initTree(e.serial,e.options),t.yhui.yhLoading&&e.parent.yhLoading("destroy")},error:function(e,i){t.yhui.log(i)}})},enable:function(){this.option("disable",!1),this.disabledDiv.eq(0).hide().end().parent("div").removeClass("yhui-dropdown-wrapdisabled")},disable:function(){if(this.option("disable",!0),t.yhui.isIE6){var e={width:this.parent.width(),height:this.parent.height(),zoom:1};this.disabledDiv.eq(0).css(e)}this.disabledDiv.eq(0).show(),this.parent.addClass("yhui-dropdown-wrapdisabled")},getTree:function(){return t.yhGetTree(this.element.data("treeId"))},parseDrop:function(){this._parseDrop(),this.__parseDrop()},widget:function(){return this.parent}})})(jQuery);