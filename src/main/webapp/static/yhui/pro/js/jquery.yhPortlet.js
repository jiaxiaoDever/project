/*!
* yhui 1.3.0beta
* jquery.yhPortlet.js
* 2013-04-23
*/
(function(t){var e={CLASS:{COLUMN:"yhui-portlet-column",PANEL:"yhui-portlet-panel ui-widget-content",HEAD:"yhui-portlet-head ui-widget-header",TITLE:"yhui-portlet-title",CONTENT:"yhui-portlet-content ui-widget-content"},DATA:{PANEL:"panelOption"},ID:{PANEL:"yhui-portlet-panel"}};t.widget("yhui.yhPortlet",{version:"1.3.0beta",options:{generateID:!1,close:null},_create:function(){this._parse(),this._sortable(),this.element.fadeIn(),this._events()},_parse:function(){this.element.addClass("yhui-portlet ui-helper-clearfix"),this.column=this.element.children("div").addClass(e.CLASS.COLUMN),this.panel=this.column.children("div").addClass(e.CLASS.PANEL),this.head=this.panel.children("h3").addClass(e.CLASS.HEAD),this.title=this.head.find("span").addClass(e.CLASS.TITLE),this.content=this.panel.children("div").addClass(e.CLASS.CONTENT),this.options.generateID&&this.column.each(function(i){t(this).children("div").each(function(t){this.id||(this.id=e.ID.PANEL+"_column_"+i+"_panel_"+t)})}),this._calSize(),this._parsePanel()},_calSize:function(){var t=this.column.length,e={};switch(t){case 1:e.width="92%",e.marginLeft="4%",e.marginRight="3%";break;case 2:e.width="47%",e.marginLeft="2%";break;case 3:e.width="30%",e.marginLeft="2.5%"}this.column.css(e)},_parsePanel:function(){var e=this;this.panel.each(function(){var i,s,a,n,o=this.children[0].getAttribute("data-option"),r={},h=0;if(o){for(i=o.split(/\s*,\s*/),a=i.length;a>h;h++)s=i[h].split(/\s*:\s*/),s[1]&&(r[s[0]]="true"===s[1]?!0:"false"===s[1]?!1:s[1]);"boolean"!=typeof r.logo||r.logo?n="string"==typeof r.logo?t("<span class = 'yhui-portlet-logo "+r.logo+"'></span>"):t("<span class = 'yhui-portlet-logo ui-icon ui-icon-triangle-1-e' ></span>"):(n=null,t.yhui.byTag(this,"h3")[0].style.paddingLeft="12px"),e.__parsePanel(r,this,n)}})},__parsePanel:function(e,i,s){if(e){var a="<a href = '#' title = '{title}' class = 'yhui-portlet-panelcontrol ui-corner-all yhui-portlet-{btn}' ><span class = 'ui-icon ui-corner-all {ico}' ></span></a>",n=t(i.children[0]),o=[],r={pop:"ui-icon-newwin",fold:"ui-icon-triangle-1-s",close:"ui-icon-close"},h={pop:"弹出内容",fold:"折叠/展开面板",close:"关闭面板"};for(var l in e)e[l]&&"logo"!==l&&o.push(a.replace(/\{btn\}/,l).replace(/\{ico\}/,r[l]).replace(/\{title\}/,h[l]));o.reverse(),s?t(o.join("")).add(s).appendTo(n):t(o.join("")).appendTo(n)}},_sortable:function(){if(!t.ui.sortable)return t.yhui.log("没有 ui.sortable！");var i=this;this.column.sortable({connectWith:"."+e.CLASS.COLUMN,tolerance:"pointer",handle:".yhui-portlet-head",helper:function(e,i){var s=t(i).outerHeight(),a=t(i).outerWidth();return"<div style = 'background-color: #EEE; width: {width}px; height: {height}px; border: 1px dashed #000; opacity: 0.5; filter: alpha(opacity=50);'></div>".replace(/\{width\}/,a).replace(/\{height\}/,s)},start:function(){t.yhui.isIE6&&i.head.css("zoom",0)},stop:function(){t.yhui.isIE6&&i.head.css("zoom",1)}})},_events:function(){var e=this;e.element.on(e._namespace("mouseenter mouseleave"),"a.yhui-portlet-panelcontrol",function(){t(this).toggleClass("ui-state-hover")}),e.element.on(e._namespace("click"),"h3>a",function(t){t.preventDefault();var i=this.className;i.indexOf("fold")>-1&&e._fold(this),i.indexOf("pop")>-1&&e._pop(this),i.indexOf("close")>-1&&e._close(this)})},_namespace:function(e){return t.yhui.parseEventType(e,this.eventNamespace)},_fold:function(e){t.yhui.isIE6&&this.head.css("zoom",0),t(e).find("span").toggleClass("ui-icon-triangle-1-s ui-icon-triangle-1-n").end().parents("h3").toggleClass("noBorderBottom").next().toggle(),t.yhui.isIE6&&this.head.css("zoom",1)},_pop:function(e){var i=t(e).parents("h3"),s=i.next(),a=i.parent(),n=t(e).siblings("span")[0].innerHTML;this._createPop(n,i,s,a)},_close:function(e){t.yhui.isIE6&&this.head.css("zoom",0),t(e).closest(".yhui-portlet-panel").find("iframe").remove().end().removeData().remove(),t.yhui.isIE6&&this.head.css("zoom",1)},_createPop:function(e,i,s,a){var n=t(window).height()-100,o=t(window).width()-200,r=s.children("*"),h=this,l={title:e,width:o,height:n,modal:!0,resizable:!1,open:function(){var e=a.height();a.css("height",e+"px"),1===r.length&&"iframe"===r[0].nodeName.toLowerCase()?(h.iframe||(h.iframe=!0),r.hide(),t("<iframe style='height:100%;width:100%' frameborder='0'></iframe>").appendTo(this).prop("src",r.prop("src")),t(this).css("overflow","hidden")):r.appendTo(this)},close:function(){h.iframe?(t(this).css("overflow","auto").find("iframe").remove(),r.prop("src",r.prop("src")).show()):r.appendTo(s),a.css("height","auto")}};this.$dialog?this.$dialog.dialog("destroy").dialog(l):this.$dialog=t("<div class = 'yhui-portlet-dialog'></div>").appendTo(this.document[0].body).dialog(l)},getOrder:function(e){for(var i=this.column.length,s=0,a={};i>s;s++)a["column"+s]=[],this.column.eq(s).children("div").each(function(){this.id?a["column"+s].push(this.id):t.yhui.log("面板id为空，portlet 可能记忆错误的位置。")});return"json"===e&&(a=JSON.stringify(a)),a}})})(jQuery);